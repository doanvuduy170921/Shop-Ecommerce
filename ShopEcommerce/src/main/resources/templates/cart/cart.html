<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Giỏ Hàng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/cart.css}"/>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>
<th:block th:insert="~{component/header.html}"></th:block>
<div class="cart-container">
    <div class="cart-header">
        <div class="cart-header-item">
            <input type="checkbox" id="select-all-header" class="form-check-input">
            <span class="ms-2">Sản Phẩm</span>
        </div>
        <div class="cart-header-item">Đơn Giá</div>
        <div class="cart-header-item">Số Lượng</div>
        <div class="cart-header-item">Số Tiền</div>
        <div class="cart-header-item">Thao Tác</div>
    </div>

    <div class="shop-container">
        <div class="product-item" th:each="item : ${cartList}">
            <input type="checkbox" class="form-check-input product-checkbox">
            <div class="product-info">
                <a th:href="${'/product/details?id='+item.product.id}">
                    <img class="product-image" th:src="${item.product.thumbnail}" src="/placeholder.svg?height=80&width=80" alt="Product Image">
                </a>
                <div>
                    <div class="product-name" th:text="${item.product.name}"></div>
                </div>
            </div>

            <div class="product-price">
                <span th:text="${item.product.price}"></span>
            </div>

            <div class="product-quantity">
                <form th:action="@{/cart/update}" method="post" class="quantity-control">
                    <button type="button" class="quantity-btn minus" onclick="decreaseQuantity(this)">−</button>
                    <input type="number" name="quantity" min="1" th:value="${item.quantity}" value="1" class="quantity-input">
                    <button type="button" class="quantity-btn plus" onclick="increaseQuantity(this)">+</button>
                    <input type="hidden" name="cart_id" th:value="${item.id}">
                </form>
            </div>

            <div class="product-total" th:text="${item.quantity * item.product.price}"></div>

            <div class="product-actions">
                <form th:action="@{/cart/remove}" method="post" style="display: inline;">
                    <input type="hidden" name="cart_id" th:value="${item.id}">
                    <button type="submit" class="delete-btn">Xóa</button>
                </form>
            </div>
        </div>
    </div>

    <div class="cart-footer">
        <div class="cart-summary">
            <div class="summary-left">
                <input type="checkbox" id="select-all-footer" class="form-check-input">
                <span class="select-all">Chọn Tất Cả (1)</span>
<!--                <span class="delete-selected">Xóa</span>-->
            </div>

            <div class="summary-right">
                <span class="total-text">Tổng thanh toán (0 sản phẩm):</span>
                <span class="total-price">₫0</span>
                <form id="checkout-form" th:action="@{/order/confirm}" method="post">
                    <input type="hidden" name="selectedItems" id="selectedItems">
                    <button type="submit" class="checkout-btn">Mua Hàng</button>
                </form>
            </div>
        </div>
    </div>
</div>
<th:block th:insert="~{component/footer.html}"></th:block>
<script>
    // Cập nhật event listener cho form checkout
    document.getElementById("checkout-form").addEventListener("submit", function (e) {
        // Ngăn form submit mặc định để kiểm tra logic trước
        e.preventDefault();

        // Lấy danh sách các sản phẩm được chọn
        let selectedItems = [];
        document.querySelectorAll(".product-checkbox:checked").forEach(checkbox => {
            const cartId = checkbox.closest(".product-item").querySelector("input[name='cart_id']").value;
            selectedItems.push(cartId);
        });

        // Kiểm tra nếu không có sản phẩm nào được chọn
        if (selectedItems.length === 0) {
            alert("Vui lòng chọn ít nhất một sản phẩm để mua hàng");
            return;
        }

        // Cập nhật giá trị input hidden
        document.getElementById("selectedItems").value = selectedItems.join(",");
        console.log("Đang gửi cart_ids: " + selectedItems.join(","));

        // Tiếp tục submit form
        this.submit();
    });

    // Cập nhật hiển thị số lượng và giá tiền trong trang
    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const count = selectedCheckboxes.length;

        // Cập nhật text "Chọn Tất Cả (x)"
        document.querySelector('.select-all').textContent = `Chọn Tất Cả (${count})`;

        // Đếm tổng số sản phẩm được chọn (số lượng)
        let totalItems = 0;
        selectedCheckboxes.forEach(checkbox => {
            const productItem = checkbox.closest('.product-item');
            const quantity = parseInt(productItem.querySelector('.quantity-input').value);
            totalItems += quantity;
        });

        // Cập nhật text "Tổng thanh toán (x sản phẩm):"
        document.querySelector('.total-text').textContent = `Tổng thanh toán (${totalItems} sản phẩm):`;

        // Cập nhật tổng giá tiền
        updateTotalPrice();
    }

    // Cập nhật tổng giá tiền của các sản phẩm được chọn
    function updateTotalPrice() {
        let totalPrice = 0;

        document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
            const productItem = checkbox.closest('.product-item');
            const totalText = productItem.querySelector('.product-total').textContent;
            const price = parseFloat(totalText.replace(/[^\d]/g, ''));

            if (!isNaN(price)) {
                totalPrice += price;
            }
        });

        // Cập nhật hiển thị tổng giá tiền
        document.querySelector('.total-price').textContent = '₫' + totalPrice.toLocaleString('vi-VN');
    }

    // Cập nhật khi thay đổi số lượng sản phẩm
    function updateTotal(input) {
        const productItem = input.closest('.product-item');
        const priceText = productItem.querySelector('.product-price span:last-child').textContent;
        const price = parseFloat(priceText.replace(/[^\d]/g, ''));
        const quantity = parseInt(input.value);

        if (isNaN(price) || isNaN(quantity)) return;

        const total = price * quantity;
        productItem.querySelector('.product-total').textContent = '₫' + total.toLocaleString('vi-VN');

        // Gửi AJAX cập nhật giỏ hàng nếu cần
        const cartId = productItem.querySelector('input[name="cart_id"]').value;
        updateCartServer(cartId, quantity);

        // Cập nhật tổng tiền và số lượng
        updateSelectedCount();
    }

    // Gửi cập nhật số lượng lên server
    function updateCartServer(cartId, quantity) {
        fetch('/cart/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `cart_id=${cartId}&quantity=${quantity}`
        })
            .then(response => {
                if (!response.ok) throw new Error('Lỗi cập nhật giỏ hàng');
                return response.text();
            })
            .then(data => {
                console.log('Cập nhật giỏ hàng thành công');
            })
            .catch(error => {
                console.error('Lỗi:', error);
            });
    }

    updateSelectedCount();

    // xu ly +
    function increaseQuantity(button) {
        let input = button.previousElementSibling;
        input.value = parseInt(input.value) + 1;
        updateTotal(input);
    }

    // xu ly -
    function decreaseQuantity(button) {
        let input = button.nextElementSibling;
        if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
            updateTotal(input);
        }
    }
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('input', function () {
            updateTotal(this);
        });
    });


    function updateTotal(input) {
        const productItem = input.closest('.product-item');
        const priceText = productItem.querySelector('.product-price span:last-child').innerText;
        const price = parseFloat(priceText.replace('₫', '').replace(/\./g, '').replace(',', '.'));
        const quantity = parseInt(input.value);
        const totalElement = productItem.querySelector('.product-total');

        const total = price * quantity;
        totalElement.innerText =total;

        updateTotalPrice();
    }

    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const count = selectedCheckboxes.length;

        document.querySelector('.select-all').textContent = `Chọn Tất Cả (${count})`;

        document.querySelector('.total-text').textContent = `Tổng thanh toán (${count} sản phẩm):`;

        updateTotalPrice();
    }

    // Calculate and update the total price of selected items
    function updateTotalPrice() {
        let totalPrice = 0;
        let totalItems = 0;

        document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
            const productItem = checkbox.closest('.product-item');
            const quantityInput = productItem.querySelector('.quantity-input');
            const quantity = parseInt(quantityInput.value);
            const totalText = productItem.querySelector('.product-total').textContent;
            const price = parseFloat(totalText.replace('₫', '').replace(/\./g, '').replace(',', '.'));

            if (!isNaN(price)) {
                totalPrice += price;
                totalItems += quantity;
            }
        });

        // Update the total price display
        document.querySelector('.total-price').textContent = '₫' + totalPrice.toLocaleString('vi-VN');
        // Update the total items count
        document.querySelector('.total-text').textContent = `Tổng thanh toán (${totalItems} sản phẩm):`;
    }

    // Sync the select all checkboxes
    document.getElementById('select-all-header').addEventListener('change', function() {
        const isChecked = this.checked;
        document.getElementById('select-all-footer').checked = isChecked;

        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });

        updateSelectedCount();
    });

    document.getElementById('select-all-footer').addEventListener('change', function() {
        const isChecked = this.checked;
        document.getElementById('select-all-header').checked = isChecked;

        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });

        updateSelectedCount();
    });

    // Product checkboxes might affect select all status
    document.querySelectorAll('.product-checkbox').forEach(productCheckbox => {
        productCheckbox.addEventListener('change', function() {
            updateSelectAllStatus();
            updateSelectedCount();
        });
    });

    function updateSelectAllStatus() {
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.product-checkbox:checked');

        const allChecked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;

        document.getElementById('select-all-header').checked = allChecked;
        document.getElementById('select-all-footer').checked = allChecked;
    }

    // Add event listeners to quantity buttons for all products
    document.querySelectorAll('.quantity-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            updateSelectedCount();
        });
    });

    // Add some sample products for demonstration if needed
    if (document.querySelectorAll('.product-item').length === 0) {
        const sampleProducts = [
            // {
            //     name: 'Tất đá bóng chống trơn, Vớ đá banh chống trượt thương hiệu Nike,Đen',
            //     price: '19900',
            //     originalPrice: '25000',
            //     variant: 'Nike,Đen',
            //     quantity: 1
            // },
            // {
            //     name: 'Áo thun thể thao nam nữ form rộng',
            //     price: '89000',
            //     originalPrice: '120000',
            //     variant: 'Trắng,XL',
            //     quantity: 1
            // },
            // {
            //     name: 'Giày thể thao chạy bộ nhẹ thoáng khí',
            //     price: '299000',
            //     originalPrice: '450000',
            //     variant: 'Đen,42',
            //     quantity: 1
            // }
        ];

        const shopContainer = document.querySelector('.shop-container');

        sampleProducts.forEach((product, index) => {
            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.innerHTML = `
                <input type="checkbox" class="form-check-input product-checkbox">

                <div class="product-info">
                    <img class="product-image" src="/placeholder.svg?height=80&width=80" alt="Product Image">
                    <div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-variant">Phân Loại Hàng: ${product.variant}</div>
                    </div>
                </div>

                <div class="product-price">
                    <span class="text-decoration-line-through text-muted me-2">₫${product.originalPrice}</span>
                    <span>₫${product.price}</span>
                </div>

                <div class="product-quantity">
                    <form class="quantity-control">
                        <button type="button" class="quantity-btn minus" onclick="decreaseQuantity(this)">−</button>
                        <input type="number" name="quantity" min="1" value="${product.quantity}" class="quantity-input">
                        <button type="button" class="quantity-btn plus" onclick="increaseQuantity(this)">+</button>
                        <input type="hidden" name="cart_id" value="${index}">
                    </form>
                </div>

                <div class="product-total">₫${product.price}</div>

                <div class="product-actions">
                    <button type="button" class="delete-btn">Xóa</button>
                </div>
            `;

            shopContainer.appendChild(productItem);

            // Add event listener to the newly created checkbox
            const checkbox = productItem.querySelector('.product-checkbox');
            checkbox.addEventListener('change', function() {
                updateSelectAllStatus();
                updateSelectedCount();
            });

            // Add event listener to the delete button
            const deleteBtn = productItem.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', function() {
                productItem.remove();
                updateSelectAllStatus();
                updateSelectedCount();
            });
        });

        // Initialize the product checkboxes
        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });

        updateSelectedCount();
    }
    function updateQuantity(element, delta) {
        let input = element.parentElement.querySelector(".quantity-input");
        let newQuantity = parseInt(input.value) + delta;
        if (newQuantity < 1) return;

        input.value = newQuantity;

        // // Update the product total display right away
        // const productItem = element.closest('.product-item');
        // const priceText = productItem.querySelector('.product-price span:last-child').innerText;
        // const price = parseFloat(priceText.replace('₫', '').replace(/\./g, '').replace(',', '.'));
        // const totalElement = productItem.querySelector('.product-total');
        //
        // const total = price * newQuantity;
        // totalElement.innerText = total;
        //
        // // Update the cart summary
        // updateSelectedCount();
        updateTotal(input);


        let cartId = element.parentElement.querySelector("input[name='cart_id']").value;

        // Gửi AJAX cập nhật số lượng
        fetch('/cart/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `cart_id=${cartId}&quantity=${newQuantity}`
        })
            .then(response => response.text())
            .then(data => {
                if (data === "success") {
                    updateCartCount(); // Cập nhật số lượng trên header
                } else {
                    console.error("Cập nhật giỏ hàng thất bại");
                }
            })
            .catch(error => console.error('Lỗi:', error));
    }

    function increaseQuantity(button) {
        updateQuantity(button, 1);
    }

    function decreaseQuantity(button) {
        updateQuantity(button, -1);
    }

</script>
</body>
</html>

